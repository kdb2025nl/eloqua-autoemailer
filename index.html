<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eloqua Campaign Generator</title>
    <!-- ≈Åadowanie Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ≈Åadowanie biblioteki ikon Lucide (Poprawiony URL) -->
    <script src="https://unpkg.com/lucide/dist/umd/lucide.js"></script>
    <style>
        /* Styl dla animacji ≈Çadowania */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        /* Ukrywanie domy≈õlnego pola wyboru pliku */
        input[type="file"].hidden {
            display: none;
        }
        /* Proste style dla zak≈Çadek */
        .tab-btn.active {
            border-bottom: 2px solid #DC0028;
            color: #DC0028;
            background-color: #fff0f3;
        }
        /* Styl dla modali */
        #assetsModal.hidden, #emailModal.hidden, #apiKeyModal.hidden, #htmlPreviewModal.hidden, #feedbackModal.hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans text-[#505050]">

    <!-- Nag≈Ç√≥wek -->
    <div class="w-full bg-[#DC0028] p-8 text-white">
        <div class="max-w-7xl mx-auto flex items-center justify-between gap-4">
            <div>
                <h1 class="text-3xl md:text-4xl font-bold">Eloqua Campaign Generator</h1>
                <p class="text-lg opacity-90">Draft multilingual email templates from any source</p>
            </div>
            <button id="apiKeyButton" class="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg flex items-center gap-2 text-sm transition-colors border border-white/20">
                <i data-lucide="key" class="w-4 h-4"></i>
                <span id="apiKeyStatus">Configure API</span>
            </button>
        </div>
    </div>

    <main class="max-w-7xl mx-auto p-4 md:p-8 space-y-8">

        <!-- Krok 1: ≈πr√≥d≈Ço -->
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
            <h2 class="text-xl font-bold mb-4 flex items-center gap-3"><span class="bg-[#DC0028] text-white rounded-full h-8 w-8 flex items-center justify-center font-bold">1</span> Choose Your Source</h2>
            <div class="flex flex-wrap gap-2 border-b border-gray-200 mb-4">
                <button id="tab-url" class="tab-btn px-4 py-2 text-sm font-semibold rounded-t-lg transition-colors flex items-center gap-2 active" data-type="url">
                    <i data-lucide="link" class="w-4 h-4"></i> URL
                </button>
                <button id="tab-text" class="tab-btn px-4 py-2 text-sm font-semibold rounded-t-lg transition-colors flex items-center gap-2" data-type="text">
                    <i data-lucide="file-type" class="w-4 h-4"></i> Text
                </button>
                <button id="tab-file" class="tab-btn px-4 py-2 text-sm font-semibold rounded-t-lg transition-colors flex items-center gap-2" data-type="file">
                    <i data-lucide="upload-cloud" class="w-4 h-4"></i> File
                </button>
            </div>

            <div id="input-container">
                <div id="input-url">
                    <input type="url" id="sourceUrl" value="" placeholder="https://example.com/article" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#DC0028] outline-none">
                </div>
                <div id="input-text" class="hidden">
                    <textarea id="sourceText" placeholder="Paste your article or text content here..." class="w-full h-32 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#DC0028] outline-none resize-y"></textarea>
                </div>
                <div id="input-file" class="hidden">
                    <div class="flex items-center gap-4">
                        <label class="cursor-pointer px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-semibold flex items-center gap-2">
                            <i data-lucide="upload-cloud" class="w-4 h-4"></i>
                            <span id="file-label">Upload File</span>
                            <input type="file" id="sourceFile" accept=".txt,.md,.text" class="hidden">
                        </label>
                        <p id="file-name" class="text-gray-600"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Krok 1.5: Brand Context -->
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
            <h2 class="text-xl font-bold mb-4 flex items-center gap-3">
                <span class="bg-[#DC0028] text-white rounded-full h-8 w-8 flex items-center justify-center font-bold text-xs">1.5</span>
                Brand Context ‚Äì Who is this email for?
            </h2>

            <label for="brandAudience" class="block text-sm font-semibold text-gray-700 mb-2">
                Select or describe your target audience:
            </label>
            <select id="brandAudience" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#DC0028] outline-none">
                <option value="existing clients">Existing clients</option>
                <option value="newsletter subscribers">Newsletter subscribers</option>
                <option value="prospective clients">Prospective clients / leads</option>
                <option value="business partners">Business partners</option>
                <option value="other">Other (specify below)</option>
            </select>

            <textarea id="brandAudienceCustom" placeholder="If 'Other', describe briefly who this email targets (e.g. CFOs in manufacturing, event attendees)..." class="w-full h-20 mt-3 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#DC0028] outline-none resize-y hidden"></textarea>

            <p class="text-xs text-gray-500 mt-2">
                üí° Tip: defining your audience helps AI match tone, formality, and message relevance.
            </p>
        </div>

        <!-- Krok 2: Wyb√≥r jƒôzyka -->
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
            <h2 class="text-xl font-bold mb-4 flex items-center gap-3"><span class="bg-[#DC0028] text-white rounded-full h-8 w-8 flex items-center justify-center font-bold">2</span> Select Languages</h2>
            <div id="language-selector" class="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-7 gap-3">
                <!-- Jƒôzyki bƒôdƒÖ wstawione przez JS -->
            </div>
        </div>

        <!-- Krok 3: Generowanie -->
        <div class="text-center space-y-2">
            <button id="generateButton" class="px-8 py-4 bg-[#DC0028] text-white rounded-lg font-semibold hover:bg-[#DC0028]/90 disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center gap-3 mx-auto shadow-lg transition-transform hover:scale-105 disabled:transform-none disabled:shadow-none">
                <i data-lucide="zap" class="w-5 h-5"></i> Generate
            </button>
            <button id="cancelButton" class="hidden px-8 py-4 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 flex items-center gap-3 mx-auto shadow-lg transition-transform hover:scale-105">
                <i data-lucide="x" class="w-5 h-5"></i> Cancel Generation
            </button>
            <p id="estimatedTime" class="text-sm text-gray-500 hidden">
                <i data-lucide="clock" class="w-4 h-4 inline"></i>
                <span id="estimatedTimeText"></span>
            </p>
        </div>

        <!-- Krok 4: Wyniki -->
        <div id="results-container" class="space-y-6">
            <!-- Wyniki bƒôdƒÖ wstawione przez JS -->
        </div>

    </main>

    <!-- Modal dla wygenerowanych zasob√≥w -->
    <div id="assetsModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 transition-opacity duration-300">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center p-4 border-b sticky top-0 bg-white z-10">
                <h3 class="text-lg font-bold flex items-center gap-2"><i data-lucide="package-plus" class="w-5 h-5 text-blue-600"></i> Generated Campaign Assets</h3>
                <button id="modalCloseButton" class="p-1 rounded-md text-gray-400 hover:bg-gray-100 hover:text-gray-700">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div id="modalContent" class="p-6 space-y-4">
                <!-- Dynamic content goes here -->
            </div>
        </div>
    </div>

    <!-- ‚ú® NOWA FUNKCJA: Modal dla E-maila -->
    <div id="emailModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 transition-opacity duration-300">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b sticky top-0 bg-white z-10">
                <h3 class="text-lg font-bold flex items-center gap-2"><i data-lucide="mail" class="w-5 h-5 text-blue-600"></i> Email Campaign Results</h3>
                <button id="emailModalCloseButton" class="p-1 rounded-md text-gray-400 hover:bg-gray-100 hover:text-gray-700">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="p-6 flex-grow overflow-y-auto">
                <p class="text-sm text-gray-600 mb-2">Copy the content below and paste it into your email client.</p>
                <textarea id="emailModalContent" readonly class="w-full h-64 md:h-96 p-3 border border-gray-200 rounded-lg bg-gray-50 font-mono text-xs"></textarea>
            </div>
            <div class="p-4 bg-gray-50 border-t rounded-b-2xl">
                <button id="emailModalCopyButton" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 flex items-center justify-center gap-2 text-sm">
                    <i data-lucide="copy" class="w-4 h-4"></i> Copy All to Clipboard
                </button>
            </div>
        </div>
    </div>

    <!-- Modal HTML Preview -->
    <div id="htmlPreviewModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 transition-opacity duration-300">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b sticky top-0 bg-white z-10">
                <h3 class="text-lg font-bold flex items-center gap-2"><i data-lucide="monitor" class="w-5 h-5 text-[#DC0028]"></i> HTML Email Preview</h3>
                <button id="htmlPreviewModalCloseButton" class="p-1 rounded-md text-gray-400 hover:bg-gray-100 hover:text-gray-700">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="p-6 flex-grow overflow-y-auto bg-gray-100">
                <iframe id="htmlPreviewFrame" class="w-full h-full min-h-[600px] bg-white rounded border border-gray-300" frameborder="0"></iframe>
            </div>
            <div class="p-4 bg-gray-50 border-t rounded-b-2xl flex gap-2">
                <button id="htmlPreviewCopyButton" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 flex items-center justify-center gap-2 text-sm">
                    <i data-lucide="copy" class="w-4 h-4"></i> Copy HTML Code
                </button>
                <button id="htmlPreviewDownloadButton" class="flex-1 px-4 py-2 bg-[#DC0028] text-white rounded-lg font-semibold hover:bg-[#DC0028]/90 flex items-center justify-center gap-2 text-sm">
                    <i data-lucide="download" class="w-4 h-4"></i> Download HTML
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Feedback -->
    <div id="feedbackModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 transition-opacity duration-300">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 class="text-lg font-bold flex items-center gap-2"><i data-lucide="message-circle" class="w-5 h-5 text-[#DC0028]"></i> Share Your Feedback</h3>
                <button id="feedbackModalCloseButton" class="p-1 rounded-md text-gray-400 hover:bg-gray-100 hover:text-gray-700">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="p-6 space-y-6">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-3">
                        How likely are you to recommend this tool? (0-10)
                    </label>
                    <div class="flex items-center gap-4">
                        <input type="range" id="npsRating" min="0" max="10" value="8" class="flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" style="accent-color: #DC0028;">
                        <span id="npsRatingValue" class="text-2xl font-bold text-[#DC0028] w-12 text-center">8</span>
                    </div>
                    <div class="flex justify-between text-xs text-gray-500 mt-2">
                        <span>Not likely</span>
                        <span>Very likely</span>
                    </div>
                </div>

                <div>
                    <label for="feedbackComment" class="block text-sm font-semibold text-gray-700 mb-2">
                        Additional comments (optional)
                    </label>
                    <textarea id="feedbackComment" placeholder="What did you like? What could be improved?" class="w-full h-24 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#DC0028] outline-none resize-y"></textarea>
                </div>

                <div class="flex items-center gap-2">
                    <input type="checkbox" id="sendToEmail" class="w-4 h-4 text-[#DC0028] border-gray-300 rounded focus:ring-[#DC0028]">
                    <label for="sendToEmail" class="text-sm text-gray-700">
                        Send feedback with generated output to <strong>author</strong>
                    </label>
                </div>

                <div id="feedbackSuccess" class="hidden p-4 bg-green-50 border border-green-200 rounded-lg text-center">
                    <div class="flex flex-col items-center gap-3">
                        <img id="feedbackGif" src="https://media.giphy.com/media/KJ1f5iTl4Oo7u/giphy.gif" alt="Thank you!" class="w-48 h-48 object-cover rounded-lg" onerror="this.style.display='none'">
                        <div class="flex items-center gap-2 text-green-700 text-sm font-semibold">
                            <i data-lucide="check-circle" class="w-4 h-4"></i>
                            <span>‚úì Feedback saved locally - Thank you!</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-4 bg-gray-50 border-t rounded-b-2xl flex gap-2">
                <button id="feedbackCancelButton" class="flex-1 px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 flex items-center justify-center gap-2 text-sm">
                    Cancel
                </button>
                <button id="feedbackSubmitButton" class="flex-1 px-4 py-2 bg-[#DC0028] text-white rounded-lg font-semibold hover:bg-[#DC0028]/90 flex items-center justify-center gap-2 text-sm">
                    <i data-lucide="send" class="w-4 h-4"></i> Submit Feedback
                </button>
            </div>
        </div>
    </div>

    <!-- Modal konfiguracji API Key -->
    <div id="apiKeyModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 transition-opacity duration-300">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 class="text-lg font-bold flex items-center gap-2"><i data-lucide="key" class="w-5 h-5 text-blue-600"></i> Configure API Key</h3>
                <button id="apiKeyModalCloseButton" class="p-1 rounded-md text-gray-400 hover:bg-gray-100 hover:text-gray-700">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <p class="text-sm text-gray-600 mb-4">Enter your Google Gemini API key to enable content generation. Your key is stored locally in your browser.</p>
                    <div class="space-y-2">
                        <label class="text-sm font-semibold text-gray-700">API Key:</label>
                        <input type="password" id="apiKeyInput" placeholder="Enter your Gemini API key..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#DC0028] outline-none">
                        <p class="text-xs text-gray-500">Get your key from: <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-600 hover:underline">Google AI Studio</a></p>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button id="apiKeySaveButton" class="flex-1 px-4 py-2 bg-[#DC0028] text-white rounded-lg font-semibold hover:bg-[#DC0028]/90 flex items-center justify-center gap-2">
                        <i data-lucide="save" class="w-4 h-4"></i> Save Key
                    </button>
                    <button id="apiKeyClearButton" class="px-4 py-2 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 flex items-center justify-center gap-2">
                        <i data-lucide="trash-2" class="w-4 h-4"></i> Clear
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Globalny skrypt aplikacji -->
    <script type="module">
        // --- KONFIGURACJA API ---

        let API_KEY = localStorage.getItem('gemini_api_key') || '';

        function getApiKey() {
            return API_KEY || '';
        }

        function setApiKey(key) {
            API_KEY = key;
            if (key) {
                localStorage.setItem('gemini_api_key', key);
            } else {
                localStorage.removeItem('gemini_api_key');
            }
            updateApiKeyStatus();
        }

        function updateApiKeyStatus() {
            const statusElement = document.getElementById('apiKeyStatus');
            const generateButton = document.getElementById('generateButton');
            if (API_KEY) {
                statusElement.textContent = 'API Key Set';
                statusElement.classList.add('text-green-300');
            } else {
                statusElement.textContent = 'Configure API';
                statusElement.classList.remove('text-green-300');
            }
        }

        // --- STA≈ÅE I TYPY (symulowane) ---

        const LANGUAGES = {
            'EN': { name: 'English', flag: 'üá¨üáß' },
            'DE': { name: 'German', flag: 'üá©üá™' },
            'NL': { name: 'Dutch', flag: 'üá≥üá±' },
            'FR': { name: 'French', flag: 'üá´üá∑' },
            'PL': { name: 'Polish', flag: 'üáµüá±' },
            'IT': { name: 'Italian', flag: 'üáÆüáπ' },
            'ES': { name: 'Spanish', flag: 'üá™üá∏' }
        };

        const API_CONCURRENCY_LIMIT = 3;

        // --- STAN APLIKACJI ---

        let state = {
            inputType: 'url',
            sourceUrl: '',
            sourceText: '',
            sourceFile: null, // { name: string, content: string }
            brandAudience: 'existing clients', // Default audience
            brandAudienceCustom: '',
            selectedLanguages: ['EN', 'DE', 'NL', 'FR'],
            isProcessing: false,
            languageStatus: null, // Record<LangCode, { status: 'idle' | 'processing' | 'success' | 'error', error?: string }>
            generatedContent: null, // Record<LangCode, EmailContent>
            isCancelledRef: false,
            assetGenerationLoading: null, // ≈öledzi ≈Çadowanie zasob√≥w
            outputFormat: 'html', // 'html' | 'json' | 'csv' - DEFAULT: HTML
            generatedHTML: {}, // Record<LangCode, string> - HTML emails
            estimatedTime: 0, // Estimated generation time in seconds
            startTime: null // Generation start timestamp
        };

        // --- REFERENCJE DO DOM ---

        const dom = {
            tabButtons: document.querySelectorAll('.tab-btn'),
            inputContainer: document.getElementById('input-container'),
            inputUrl: document.getElementById('input-url'),
            inputText: document.getElementById('input-text'),
            inputFile: document.getElementById('input-file'),
            sourceUrlInput: document.getElementById('sourceUrl'),
            sourceTextInput: document.getElementById('sourceText'),
            sourceFileInput: document.getElementById('sourceFile'),
            fileLabel: document.getElementById('file-label'),
            fileName: document.getElementById('file-name'),
            brandAudienceSelect: document.getElementById('brandAudience'),
            brandAudienceCustom: document.getElementById('brandAudienceCustom'),
            languageSelector: document.getElementById('language-selector'),
            generateButton: document.getElementById('generateButton'),
            cancelButton: document.getElementById('cancelButton'),
            resultsContainer: document.getElementById('results-container'),
            // Modal zasob√≥w
            assetsModal: document.getElementById('assetsModal'),
            assetsModalContent: document.getElementById('modalContent'),
            assetsModalCloseButton: document.getElementById('modalCloseButton'),
            // ‚ú® NOWY DOM: Modal E-mail
            emailModal: document.getElementById('emailModal'),
            emailModalContent: document.getElementById('emailModalContent'),
            emailModalCopyButton: document.getElementById('emailModalCopyButton'),
            emailModalCloseButton: document.getElementById('emailModalCloseButton')
        };

        // --- FUNKCJE POMOCNICZE ---

        const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        function extractJSON(text) {
            if (!text) return null;
            const startIndex = text.indexOf('{');
            const endIndex = text.lastIndexOf('}');
            if (startIndex === -1 || endIndex === -1 || endIndex < startIndex) return null;
            const jsonCandidate = text.substring(startIndex, endIndex + 1);
            try {
                const parsed = JSON.parse(jsonCandidate);
                if (parsed.subject && parsed.preheader && parsed.body && parsed.cta) {
                    return {
                        subject: parsed.subject,
                        preheader: parsed.preheader,
                        body: parsed.body,
                        cta: parsed.cta,
                        keyInsights: Array.isArray(parsed.keyInsights) ? parsed.keyInsights : [],
                    };
                }
            } catch (e) {
                console.error("JSON parsing failed:", e);
            }
            return null;
        }

        function safeClipboardCopy(text, onCopy) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.left = "-9999px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                if (onCopy) onCopy();
            } catch (err) {
                console.error('Failed to copy text: ', err);
            }
            document.body.removeChild(textArea);
        }

        function getSourceContent() {
            switch (state.inputType) {
                case 'url': return state.sourceUrl;
                case 'text': return state.sourceText;
                case 'file': return state.sourceFile?.content || '';
                default: return '';
            }
        }

        function checkReadiness() {
            const sourceContent = getSourceContent();
            const isReady = !!sourceContent.trim() && state.selectedLanguages.length > 0;
            dom.generateButton.disabled = !isReady || state.isProcessing;
        }

        const getBasePrompt = (languageName, isHTML = false) => {
            const sourceContent = getSourceContent();
            const sourceIdentifier = state.inputType === 'url' ? `the article at ${sourceContent}` : `the following text`;
            const sourceData = state.inputType !== 'url' ? `\n\n---SOURCE TEXT---\n${sourceContent}\n---END SOURCE TEXT---` : '';

            // Get audience context
            const audience = state.brandAudience === 'other' && state.brandAudienceCustom
                ? state.brandAudienceCustom
                : state.brandAudience;
            const audienceContext = `\n\nTARGET AUDIENCE: ${audience}. Tailor the tone, formality, and message relevance accordingly.`;

            if (isHTML) {
                return `Based on ${sourceIdentifier}, generate a complete responsive HTML email for Atradius Collections in ${languageName}.${audienceContext}

CRITICAL: Output ONLY clean HTML code. No markdown, no comments, no explanations. Just pure HTML.

Extract any images from the source and use their full URLs (https://...). If no images found, use https://via.placeholder.com/600x200.

Use this exact structure (table-based responsive email):
- Outer table: width="100%" bgcolor="#F2F2F2"
- Inner table: max-width:600px, margin:0 auto, bgcolor="#ffffff"
- All CSS must be INLINE (no <style> in <head>)
- Use Atradius Collections branding: #DC0028 (red), #505050 (text), #BFBFBF (grey)
- Include: logo area, hero image, main content (150-200 words), CTA button (#DC0028), footer
- Button style: background-color:#DC0028; color:#fff; padding:10px 20px; border-radius:2px;
- Maintain proper spacing with padding in <td> elements
- Use font-family: Arial, Helvetica, sans-serif
- Add alt text to all images
- Include MSO conditional comments for Outlook compatibility

BRAND VOICE (apply to all text):
- CLEAR: Simple language, active voice, sentences under 18 words
- CONFIDENT: Strong, direct, no ambiguity
- HELPFUL: Focus on reader benefit, warm and professional

CRITICAL RULES FOR CONTENT:
- NO PLACEHOLDERS: Never use [Company Name], [Your Name], [Link], or any bracketed text
- Use real content from the source material
- Lead with customer benefits, be specific and concrete
- Use warm, professional tone - like a conversation with a business contact
- AVOID absolute/categorical statements like "gives a clear picture", "complete clarity", "the only solution"
- Use nuanced language: "can help", "tends to", "often shows", "may improve", "suggests"

Generate the complete HTML structure with:
1. Header with Atradius Collections logo (use real logo URL: https://image.e.atradius.com/EloquaImages/clients/atradiuscollections/{0529efc5-58fd-4150-8e3b-74c3440d5d6d}_AC-Logo-Color-50px.png)
2. Hero image (extract from source or use: https://via.placeholder.com/600x200)
3. Main headline (compelling, max 15 words, sentence case)
4. Body content (150-200 words, present insights naturally, use nuanced language)
5. At the END of body, add a "Key insights:" section with 2-3 bullet points (checkmarks ‚úîÔ∏è)
6. CTA button (actionable, max 5 words)
7. Footer with unsubscribe link

Output ONLY the HTML code, starting with <!DOCTYPE html>.${sourceData}`;
            }

            return `Based on ${sourceIdentifier}, generate professional email content in ${languageName}.${audienceContext}

BRAND VOICE GUIDELINES (CRITICAL - MUST FOLLOW):
You must embody these three core qualities in ALL content:

1. CLEAR: Use simple, straightforward language. Avoid jargon and complicated terms. Keep sentences under 18 words where possible. Use active voice, not passive. Get to the point quickly. Use contractions (we're, you're, it's) to feel warmer and more natural.

2. CONFIDENT: Use strong, dynamic words. Be direct and leave no room for doubt. Showcase expertise without being boastful. Use words like: ability, action, confident, determination, enable, robust, succeed, transform.

3. HELPFUL: Focus on the reader and their needs. Be warm and human. Think about what value you're providing. Use words like: support, ease, helpful, dedicated, together, clarity, relief.

WRITING STYLE RULES:
- Use British English spelling and grammar (organisations not organizations, colour not color)
- Always use active voice ("We help you" NOT "You are helped by us")
- Use contractions to sound natural (we're, you'll, it's)
- Avoid formal, old-fashioned language (don't use: notwithstanding, whereby, furthermore)
- Avoid jargon - write as if speaking to an intelligent professional in a warm conversation
- Lead with customer benefits, not company features
- Include people and human elements where possible
- Be specific and concrete, avoid ambiguity
- NEVER use placeholders like [Company Name], [Link], [Your Name] - always use real content
- AVOID absolute/categorical statements like "It gives a clear picture", "This provides complete clarity", "It's the only solution"
- Use nuanced language: "can help", "tends to", "often shows", "may improve", "suggests", "indicates"
- Present data and trends, let the reader draw conclusions

Please create:
1. A compelling, client-focused subject line (max 15 words). Use sentence case - only capitalize the first word and proper nouns. Be clear, confident, and focus on the reader benefit.

2. A short, engaging preheader (max 20 words) that appears after the subject line. Make it helpful and intriguing.

3. A professional email body (approx. 150-200 words). Structure it with:
   - An engaging opening that acknowledges our partnership
   - Main content presenting insights and data from the source material
   - Use nuanced language - avoid absolute statements
   - A clear call-to-action (be confident and direct)
   - At the END of the body, add: "\\n\\nKey insights:\\n" followed by 2-3 bullet points (use ‚Ä¢ as bullets)
   - Each bullet should be a concise, specific insight (one line each)
   - Use '\\n' for new paragraphs to ensure proper formatting
   - Keep sentences varied in length but aim for under 18 words
   - Use warm, professional language - imagine a conversation with a business contact
   - Balance "you/your" with "we/our" naturally - focus on the relationship and shared success

4. A short, actionable call-to-action text (max 5 words). Be confident and direct.

5. Key insights: 2-3 clear, specific insights from the source material. These should match the bullet points at the end of the email body.

Remember: Be CLEAR (simple language), CONFIDENT (strong and direct), HELPFUL (focused on the reader's needs).

Format the entire response as a single, clean JSON object, with no surrounding text or markdown.${sourceData}`;
        };

        // --- LOGIKA API GEMINI ---

        async function callGeminiForHTML(prompt) {
            const apiKey = getApiKey();
            if (!apiKey) throw new Error("API key not configured");
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-pro:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "text/plain"
                }
            };

            let attempts = 0;
            while (attempts < 3) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error(`API request failed with status ${response.status}`);
                    const result = await response.json();
                    const candidate = result.candidates?.[0];
                    const htmlContent = candidate?.content?.parts?.[0]?.text;
                    if (htmlContent) {
                        return htmlContent;
                    } else {
                        throw new Error("Invalid API response structure");
                    }
                } catch (error) {
                    attempts++;
                    console.error(`Attempt ${attempts} failed:`, error);
                    if (attempts >= 3) throw error;
                    await sleep(1000 * attempts);
                }
            }
            throw new Error("API call failed after multiple retries.");
        }

        async function callGeminiApi(prompt) {
            const apiKey = getApiKey();
            if (!apiKey) throw new Error("API key not configured");
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-pro:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            subject: { type: "STRING" },
                            preheader: { type: "STRING" },
                            body: { type: "STRING" },
                            cta: { type: "STRING" },
                            keyInsights: { type: "ARRAY", items: { type: "STRING" } }
                        },
                        required: ["subject", "preheader", "body", "cta", "keyInsights"]
                    }
                }
            };

            let attempts = 0;
            while (attempts < 3) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error(`API request failed with status ${response.status}`);
                    const result = await response.json();
                    const candidate = result.candidates?.[0];
                    const contentText = candidate?.content?.parts?.[0]?.text;
                    if (contentText) {
                        const parsedJson = JSON.parse(contentText);
                        return { keyInsights: [], ...parsedJson };
                    } else {
                        throw new Error("Invalid API response structure");
                    }
                } catch (error) {
                    attempts++;
                    console.error(`Attempt ${attempts} failed:`, error);
                    if (attempts >= 3) throw error;
                    await sleep(1000 * attempts);
                }
            }
            throw new Error("API call failed after multiple retries.");
        }


        async function callGeminiForAssets(prompt) {
            const apiKey = getApiKey();
            if (!apiKey) throw new Error("API key not configured");
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-pro:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            linkedinPost: { type: "STRING" },
                            twitterPost: { type: "STRING" },
                            imagePrompt: { type: "STRING" },
                            audiencePersonas: {
                                type: "ARRAY",
                                items: {
                                    type: "OBJECT",
                                    properties: {
                                        name: { type: "STRING" },
                                        description: { type: "STRING" }
                                    },
                                    required: ["name", "description"]
                                }
                            }
                        },
                        required: ["linkedinPost", "twitterPost", "imagePrompt", "audiencePersonas"]
                    }
                }
            };

            let attempts = 0;
            while (attempts < 3) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error(`API request failed with status ${response.status}`);
                    const result = await response.json();
                    const candidate = result.candidates?.[0];
                    const contentText = candidate?.content?.parts?.[0]?.text;
                    if (contentText) {
                        return JSON.parse(contentText);
                    } else {
                        throw new Error("Invalid API response structure");
                    }
                } catch (error) {
                    attempts++;
                    console.error(`Attempt ${attempts} failed:`, error);
                    if (attempts >= 3) throw error;
                    await sleep(1000 * attempts);
                }
            }
            throw new Error("API call failed after multiple retries.");
        }



        // --- HANDLERY ZDARZE≈É ---

        function handleTabClick(e) {
            const btn = e.target.closest('.tab-btn');
            if (!btn) return;

            const type = btn.dataset.type;
            state.inputType = type;

            dom.tabButtons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            dom.inputUrl.classList.toggle('hidden', type !== 'url');
            dom.inputText.classList.toggle('hidden', type !== 'text');
            dom.inputFile.classList.toggle('hidden', type !== 'file');

            checkReadiness();
        }

        function handleFileChange(e) {
            const file = e.target.files?.[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    state.sourceFile = { name: file.name, content: e.target?.result };
                    dom.fileName.textContent = file.name;
                    dom.fileLabel.textContent = 'Change File';
                    checkReadiness();
                };
                reader.readAsText(file);
            }
            e.target.value = ''; // Reset file input
        }

        function toggleLanguage(langCode) {
            const index = state.selectedLanguages.indexOf(langCode);
            if (index > -1) {
                state.selectedLanguages.splice(index, 1);
            } else {
                state.selectedLanguages.push(langCode);
            }
            renderLanguageSelector();
            checkReadiness();
        }

        async function handleGenerate() {
            if (!checkReadiness() && state.isProcessing) return;

            // Sprawd≈∫ czy API key jest ustawiony
            if (!getApiKey()) {
                showApiKeyModal();
                return;
            }

            state.isProcessing = true;
            state.isCancelledRef = false;
            state.generatedContent = {};
            state.generatedHTML = {};
            state.startTime = Date.now();

            // Calculate estimated time - more realistic (30-35 seconds per language for HTML, 15-20 for JSON)
            const timePerLang = state.outputFormat === 'html' ? 32 : 18;
            state.estimatedTime = state.selectedLanguages.length * timePerLang;

            updateButtons();

            const initialStatus = state.selectedLanguages.reduce((acc, lang) => {
                acc[lang] = { status: 'processing' };
                return acc;
            }, {});
            state.languageStatus = initialStatus;

            renderResults(); // Poka≈º szkielety kart

            // Start timer to update estimated time
            const timerInterval = setInterval(() => {
                if (!state.isProcessing) {
                    clearInterval(timerInterval);
                    return;
                }
                updateButtons();
            }, 1000);

            const processLanguage = async (langCode) => {
                if (state.isCancelledRef) return;
                try {
                    // Generate JSON content
                    const prompt = getBasePrompt(LANGUAGES[langCode].name, false);
                    const content = await callGeminiApi(prompt);
                    if (state.isCancelledRef) return;

                    state.generatedContent[langCode] = content;

                    // If HTML format selected, also generate HTML
                    if (state.outputFormat === 'html') {
                        const htmlPrompt = getBasePrompt(LANGUAGES[langCode].name, true);
                        const htmlContent = await callGeminiForHTML(htmlPrompt);
                        if (state.isCancelledRef) return;
                        state.generatedHTML[langCode] = htmlContent;
                    }

                    state.languageStatus[langCode] = { status: 'success' };
                    renderCardContent(langCode); // Zaktualizuj konkretnƒÖ kartƒô
                } catch (error) {
                    console.error(`Error generating for ${langCode}:`, error);
                    if (state.isCancelledRef) return;
                    state.languageStatus[langCode] = { status: 'error', error: error.message };
                    renderCardContent(langCode); // Poka≈º b≈ÇƒÖd na karcie
                }
            };

            const tasks = state.selectedLanguages.map(langCode => () => processLanguage(langCode));
            const activeTasks = [];
            for (const task of tasks) {
                if(state.isCancelledRef) break;
                const promise = task();
                activeTasks.push(promise);
                if (activeTasks.length >= API_CONCURRENCY_LIMIT) {
                    await Promise.race(activeTasks);
                    activeTasks.splice(activeTasks.findIndex(p => p === Promise.race(activeTasks)), 1);
                }
            }
            await Promise.all(activeTasks);

            // ‚ú® POPRAWKA: Ponownie renderuj ca≈ÇƒÖ sekcjƒô wynik√≥w, aby poprawnie zaktualizowaƒá status przycisk√≥w eksportu
            renderResults();

            state.isProcessing = false;
            state.isCancelledRef = false;
            updateButtons();
        }

        function handleCancel() {
            state.isCancelledRef = true;
            state.isProcessing = false;
            if (state.languageStatus) {
                Object.keys(state.languageStatus).forEach(key => {
                    if (state.languageStatus[key].status === 'processing') {
                        state.languageStatus[key] = { status: 'idle' };
                    }
                });
            }
            renderResults();
            updateButtons();
        }

        function handleManualPaste(langCode, text) {
            const json = extractJSON(text);
            if (json) {
                state.generatedContent[langCode] = json;
                state.languageStatus[langCode] = { status: 'success' };
                renderCardContent(langCode);
            } else {
                state.languageStatus[langCode] = { status: 'error', error: 'Invalid JSON' };
                renderCardContent(langCode); // Poka≈º b≈ÇƒÖd (np. czerwona ramka)
                const textarea = document.querySelector(`#card-${langCode} textarea`);
                if(textarea) {
                    textarea.classList.add('border-red-400', 'focus:ring-red-400');
                    textarea.classList.remove('border-gray-300', 'focus:ring-[#DC0028]');
                }
            }
        }


        async function handleGenerateAssets(langCode) {
            const content = state.generatedContent?.[langCode];
            if (!content) return;

            state.assetGenerationLoading = langCode;
            renderCardContent(langCode); // Poka≈º ≈Çadowanie na przycisku

            const prompt = `Based on the following email content, generate marketing assets to promote it.

BRAND VOICE - APPLY TO ALL ASSETS:
- CLEAR: Simple, straightforward language. Avoid jargon. Use active voice. Get to the point quickly.
- CONFIDENT: Strong, direct words. Be assertive without being boastful. Use dynamic language.
- HELPFUL: Focus on reader benefit and value. Be warm and human.

STYLE RULES (ALL CONTENT):
- Use British English spelling and grammar
- Use contractions naturally (we're, you'll, it's)
- Use active voice consistently
- Avoid jargon and complicated terminology
- Lead with customer benefits, not features
- Be specific and concrete

Create:
1. A professional LinkedIn post (150-200 words). Make it CLEAR, CONFIDENT, and HELPFUL. Structure: engaging opening, 2-3 key points, call-to-action. Use newlines (\\n) for paragraph formatting. Focus on insights that help the reader.

2. A concise and engaging X (Twitter) post (under 280 characters). Be punchy and benefit-focused. Lead with value. Use active voice.

3. A descriptive image generation prompt for a text-to-image AI. Be specific about composition, mood, style, and key elements. Make it professional and aligned with business context.

4. An array of 3 brief target audience personas. For each: a clear role/title name, and a 2-sentence description focusing on their business challenges and what value they seek.

Respond with a single JSON object: {"linkedinPost": "...", "twitterPost": "...", "imagePrompt": "...", "audiencePersonas": [{"name": "...", "description": "..."}, ...]}

Email Subject: ${content.subject}
Email Body:
${content.body}`;

            try {
                const assets = await callGeminiForAssets(prompt);
                if (assets) {
                    showModal(langCode, assets);
                }
            } catch (error) {
                console.error(`Failed to generate assets for ${langCode}:`, error);
            } finally {
                state.assetGenerationLoading = null;
                renderCardContent(langCode); // Usu≈Ñ ≈Çadowanie z przycisku
            }
        }

        function showModal(langCode, assets) {
            const { linkedinPost, twitterPost, imagePrompt, audiencePersonas } = assets;

            const personasHTML = (audiencePersonas && audiencePersonas.length > 0) ? `
                <div>
                    <strong class="text-sm font-semibold flex items-center gap-2 mb-2"><i data-lucide="users" class="w-4 h-4 text-green-600"></i> Target Personas</strong>
                    <div class="space-y-2">
                        ${audiencePersonas.map(persona => `
                            <div class="p-3 bg-gray-50 rounded border">
                                <strong class="text-sm text-gray-800">${persona.name}</strong>
                                <p class="text-sm text-gray-600">${persona.description}</p>
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : '';

            dom.assetsModalContent.innerHTML = `
                <div class="space-y-6">
                    ${personasHTML}
                    <div>
                        <div class="flex items-center justify-between mb-1">
                            <strong class="text-sm font-semibold flex items-center gap-2"><i data-lucide="linkedin" class="w-4 h-4 text-blue-700"></i> LinkedIn Post</strong>
                            ${createCopyButton(linkedinPost)}
                        </div>
                        <p class="p-3 bg-gray-50 text-sm rounded border whitespace-pre-wrap">${linkedinPost.replace(/\\n/g, '\n')}</p>
                    </div>
                    <div>
                        <div class="flex items-center justify-between mb-1">
                            <strong class="text-sm font-semibold flex items-center gap-2"><i data-lucide="twitter" class="w-4 h-4 text-sky-500"></i> X (Twitter) Post</strong>
                            ${createCopyButton(twitterPost)}
                        </div>
                        <p class="p-3 bg-gray-50 text-sm rounded border whitespace-pre-wrap">${twitterPost.replace(/\\n/g, '\n')}</p>
                    </div>
                    <div>
                        <div class="flex items-center justify-between mb-1">
                            <strong class="text-sm font-semibold flex items-center gap-2"><i data-lucide="image" class="w-4 h-4 text-purple-600"></i> Image Prompt</strong>
                            ${createCopyButton(imagePrompt)}
                        </div>
                        <p class="p-3 bg-gray-50 text-sm rounded border italic text-gray-700">${imagePrompt}</p>
                        <p class="text-xs text-gray-500 mt-2">Use this prompt with your preferred AI image generator (e.g., DALL-E, Midjourney, Stable Diffusion)</p>
                    </div>
                </div>
            `;
            dom.assetsModal.classList.remove('hidden');

            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        function hideModal() {
            dom.assetsModal.classList.add('hidden');
            dom.assetsModalContent.innerHTML = '';
        }

        // --- ‚ú® NOWE FUNKCJE: Obs≈Çuga modala e-mail ---

        /**
         * Formatuje ca≈ÇƒÖ wygenerowanƒÖ tre≈õƒá do pojedynczego stringa
         */
        function formatContentForEmail() {
            let fullText = "ELOQUA CAMPAIGN GENERATOR - EXPORTED RESULTS\n";
            fullText += `Generated on: ${new Date().toLocaleString()}\n`;
            fullText += `Source: ${getSourceContent()}\n\n`;

            if (!state.generatedContent || Object.keys(state.generatedContent).length === 0) {
                return fullText + "No content generated.";
            }

            for (const langCode of state.selectedLanguages) {
                const content = state.generatedContent[langCode];
                if (content) {
                    const lang = LANGUAGES[langCode];
                    fullText += `==================================\n`;
                    fullText += `LANGUAGE: ${lang.name} (${langCode}) ${lang.flag}\n`;
                    fullText += `==================================\n\n`;
                    fullText += `Subject: ${content.subject}\n`;
                    fullText += `Preheader: ${content.preheader}\n`;
                    fullText += `CTA: ${content.cta}\n\n`;

                    fullText += `Body:\n${content.body.replace(/\\n/g, '\n')}\n\n`;

                    if (content.keyInsights && content.keyInsights.length > 0) {
                        fullText += `Key Insights:\n${content.keyInsights.map(insight => `- ${insight}`).join('\n')}\n\n`;
                    }
                }
            }
            return fullText;
        }

        /**
         * Otwiera modal e-maila
         */
        function showEmailModal() {
            const emailBody = formatContentForEmail();
            dom.emailModalContent.value = emailBody;
            dom.emailModal.classList.remove('hidden');
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        /**
         * Zamyka modal e-maila
         */
        function hideEmailModal() {
            dom.emailModal.classList.add('hidden');
            dom.emailModalContent.value = '';
        }

        /**
         * Kopiuje zawarto≈õƒá e-maila i pokazuje potwierdzenie
         */
        function copyEmailContent() {
            const content = dom.emailModalContent.value;
            safeClipboardCopy(content, () => {
                const btn = dom.emailModalCopyButton;
                btn.innerHTML = '<i data-lucide="check-circle" class="w-4 h-4"></i> Copied!';
                btn.classList.add('bg-green-600', 'hover:bg-green-700');
                btn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }

                setTimeout(() => {
                    btn.innerHTML = '<i data-lucide="copy" class="w-4 h-4"></i> Copy All to Clipboard';
                    btn.classList.remove('bg-green-600', 'hover:bg-green-700');
                    btn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                    if (typeof lucide !== 'undefined') {
                        lucide.createIcons();
                    }
                }, 2000);
            });
        }

        // --- FUNKCJE ZARZƒÑDZANIA HTML PREVIEW MODAL ---

        let currentPreviewHTML = '';
        let currentPreviewLangCode = '';

        function showHTMLPreview(langCode) {
            const htmlContent = state.generatedHTML[langCode];
            if (!htmlContent) return;

            currentPreviewHTML = htmlContent;
            currentPreviewLangCode = langCode;

            const modal = document.getElementById('htmlPreviewModal');
            const iframe = document.getElementById('htmlPreviewFrame');

            // Load HTML into iframe
            iframe.srcdoc = htmlContent;

            modal.classList.remove('hidden');
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        function hideHTMLPreview() {
            const modal = document.getElementById('htmlPreviewModal');
            modal.classList.add('hidden');
            currentPreviewHTML = '';
            currentPreviewLangCode = '';
        }

        function copyHTMLCode() {
            if (!currentPreviewHTML) return;
            safeClipboardCopy(currentPreviewHTML, () => {
                const btn = document.getElementById('htmlPreviewCopyButton');
                const originalHTML = btn.innerHTML;
                btn.innerHTML = '<i data-lucide="check-circle" class="w-4 h-4"></i> Copied!';
                btn.classList.add('bg-green-600', 'hover:bg-green-700');
                btn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    btn.classList.remove('bg-green-600', 'hover:bg-green-700');
                    btn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                    if (typeof lucide !== 'undefined') {
                        lucide.createIcons();
                    }
                }, 2000);
            });
        }

        function downloadHTMLFromPreview() {
            if (!currentPreviewHTML || !currentPreviewLangCode) return;
            const blob = new Blob([currentPreviewHTML], { type: 'text/html;charset=utf-8' });
            const filename = `atradius-email-${currentPreviewLangCode.toLowerCase()}.html`;
            downloadBlob(blob, filename);
        }

        // --- FUNKCJE ZARZƒÑDZANIA FEEDBACK MODAL ---

        function showFeedbackModal() {
            const modal = document.getElementById('feedbackModal');
            document.getElementById('feedbackSuccess').classList.add('hidden');
            document.getElementById('feedbackComment').value = '';
            document.getElementById('sendToEmail').checked = false;
            modal.classList.remove('hidden');
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        function hideFeedbackModal() {
            const modal = document.getElementById('feedbackModal');
            modal.classList.add('hidden');
        }

        async function submitFeedback() {
            const rating = document.getElementById('npsRating').value;
            const comment = document.getElementById('feedbackComment').value;
            const sendEmail = document.getElementById('sendToEmail').checked;

            const feedback = {
                rating: parseInt(rating),
                comment: comment,
                timestamp: new Date().toISOString(),
                generatedContent: state.generatedContent,
                selectedLanguages: state.selectedLanguages,
                outputFormat: state.outputFormat
            };

            // Save locally
            const existingFeedback = JSON.parse(localStorage.getItem('eloqua_feedback') || '[]');
            existingFeedback.push(feedback);
            localStorage.setItem('eloqua_feedback', JSON.stringify(existingFeedback));

            // Show success message
            document.getElementById('feedbackSuccess').classList.remove('hidden');
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }

            // Send email if checkbox is checked
            if (sendEmail) {
                await sendFeedbackEmail(feedback);
            }

            // Close modal after 8 seconds to show the GIF
            setTimeout(() => {
                hideFeedbackModal();
            }, 8000);
        }

        async function sendFeedbackEmail(feedback) {
            const emailBody = `
NPS Rating: ${feedback.rating}/10

Comment:
${feedback.comment || 'No comment provided'}

---
Generated Output:
${JSON.stringify(feedback.generatedContent, null, 2)}

Languages: ${feedback.selectedLanguages.join(', ')}
Format: ${feedback.outputFormat}
Timestamp: ${feedback.timestamp}
            `.trim();

            // Create mailto link
            const subject = encodeURIComponent(`Eloqua Generator Feedback - NPS ${feedback.rating}`);
            const body = encodeURIComponent(emailBody);
            const mailtoLink = `mailto:kamil.blasiak@atradius.com?subject=${subject}&body=${body}`;

            // Open default email client
            window.location.href = mailtoLink;
        }

        // --- FUNKCJE ZARZƒÑDZANIA API KEY MODAL ---

        function showApiKeyModal() {
            const modal = document.getElementById('apiKeyModal');
            const input = document.getElementById('apiKeyInput');
            input.value = API_KEY;
            modal.classList.remove('hidden');
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        function hideApiKeyModal() {
            const modal = document.getElementById('apiKeyModal');
            modal.classList.add('hidden');
        }

        function saveApiKey() {
            const input = document.getElementById('apiKeyInput');
            const key = input.value.trim();
            setApiKey(key);
            hideApiKeyModal();
            if (key) {
                alert('API Key saved successfully!');
            }
        }

        function clearApiKey() {
            if (confirm('Are you sure you want to clear the API key?')) {
                setApiKey('');
                document.getElementById('apiKeyInput').value = '';
                hideApiKeyModal();
            }
        }

        // ---

        function handleResultsClick(e) {
            const button = e.target.closest('button[data-action]');
            if (!button) return;

            const { action, lang, tone, text } = button.dataset;

            if (action === 'copy') {
                safeClipboardCopy(decodeURIComponent(text), () => {
                    const icon = button.querySelector('i');
                    if (icon) {
                        const originalIcon = icon.dataset.lucide;
                        icon.setAttribute('data-lucide', 'check-circle');
                        icon.classList.add('text-green-500');
                        lucide.createIcons();
                        setTimeout(() => {
                            icon.setAttribute('data-lucide', originalIcon);
                            icon.classList.remove('text-green-500');
                            lucide.createIcons();
                        }, 2000);
                    }
                });
            } else if (action === 'generate-assets') {
                handleGenerateAssets(lang);
            } else if (action === 'preview-html') {
                showHTMLPreview(lang);
            } else if (action === 'share-feedback') {
                showFeedbackModal();
            }
        }

        function downloadBlob(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function exportData(format) {
            if (!state.generatedContent) return;

            if (format === 'json') {
                const data = Object.entries(state.generatedContent).map(([lang, content]) => ({
                    language_code: lang,
                    language_name: LANGUAGES[lang].name,
                    subject: content.subject,
                    preheader: content.preheader,
                    body: content.body,
                    cta: content.cta,
                    key_insights: content.keyInsights.join('; ')
                }));
                downloadBlob(new Blob([JSON.stringify(data, null, 2)], { type: "application/json;charset=utf-8" }), 'eloqua-content.json');
            } else if (format === 'csv') {
                // CSV format: jƒôzyk, tytu≈Ç (subject), opis (body), CTA
                const data = Object.entries(state.generatedContent).map(([lang, content]) => ({
                    language: LANGUAGES[lang].name,
                    subject: content.subject,
                    body: content.body,
                    cta: content.cta
                }));
                const header = Object.keys(data[0]).join(',');
                const rows = data.map(row => Object.values(row).map(val => `"${String(val).replace(/"/g, '""').replace(/\n/g, ' ')}"`).join(','));
                downloadBlob(new Blob([`${header}\n${rows.join('\n')}`], { type: "text/csv;charset=utf-8" }), 'eloqua-content.csv');
            }
        }

        // --- FUNKCJE RENDERUJƒÑCE ---

        function renderLanguageSelector() {
            dom.languageSelector.innerHTML = Object.entries(LANGUAGES).map(([code, lang]) => `
                <button
                    class="p-3 rounded-lg border-2 text-center transition-all ${state.selectedLanguages.includes(code) ? 'border-[#DC0028] bg-red-50' : 'border-gray-200 hover:border-gray-300'}"
                    data-lang="${code}"
                >
                    <span class="text-3xl" role="img" aria-label="${lang.name}">${lang.flag}</span>
                    <div class="font-bold mt-1">${code}</div>
                    <div class="text-xs text-gray-500">${lang.name}</div>
                </button>
            `).join('');

            // Ponowne podpiƒôcie listener√≥w
            dom.languageSelector.querySelectorAll('button').forEach(btn => {
                btn.addEventListener('click', () => toggleLanguage(btn.dataset.lang));
            });
        }

        function updateButtons() {
            dom.generateButton.classList.toggle('hidden', state.isProcessing);
            dom.cancelButton.classList.toggle('hidden', !state.isProcessing);

            const estimatedTimeEl = document.getElementById('estimatedTime');
            const estimatedTimeText = document.getElementById('estimatedTimeText');

            if (state.isProcessing && state.estimatedTime > 0) {
                const elapsed = Math.floor((Date.now() - state.startTime) / 1000);
                const remaining = Math.max(0, state.estimatedTime - elapsed);
                estimatedTimeText.textContent = `Estimated time: ~${remaining}s remaining`;
                estimatedTimeEl.classList.remove('hidden');
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            } else {
                estimatedTimeEl.classList.add('hidden');
            }

            checkReadiness();
        }

        function createCopyButton(textToCopy, icon = 'copy') {
            return `
                <button
                    class="p-1.5 text-gray-500 hover:text-blue-600 hover:bg-gray-100 rounded-md transition-colors"
                    data-action="copy"
                    data-text="${encodeURIComponent(textToCopy)}"
                >
                    <i data-lucide="${icon}" class="w-4 h-4"></i>
                </button>
            `;
        }

        function renderCardContent(langCode) {
            const card = document.getElementById(`card-${langCode}`);
            if (!card) return;

            const contentContainer = card.querySelector('.content-container');
            const statusContainer = card.querySelector('.status-container');

            const status = state.languageStatus[langCode];
            const content = state.generatedContent[langCode];

            // Aktualizacja statusu
            let statusIcon = '';
            if (status.status === 'processing') {
                statusIcon = '<i data-lucide="loader-2" class="w-5 h-5 animate-spin text-[#DC0028]"></i>';
            } else if (status.status === 'success' && content) {
                statusIcon = '<i data-lucide="check-circle" class="w-5 h-5 text-green-500"></i>';
            } else if (status.status === 'error') {
                statusIcon = `<i data-lucide="alert-triangle" class="w-5 h-5 text-red-500" title="${status.error}"></i>`;
            }
            statusContainer.innerHTML = statusIcon;

            // Aktualizacja tre≈õci
            if (content) {
                const insights = content.keyInsights || [];

                contentContainer.innerHTML = `
                    <div class="space-y-3">
                        <div class="flex items-center justify-between pt-2"><strong class="text-sm">Subject:</strong>
                            ${createCopyButton(content.subject)}
                        </div>
                        <p class="p-2 bg-yellow-50 text-sm rounded">${content.subject}</p>

                        <div class="flex items-center justify-between pt-2"><strong class="text-sm">Preheader:</strong> ${createCopyButton(content.preheader)}</div>
                        <p class="p-2 bg-blue-50 text-sm rounded">${content.preheader}</p>

                        <div class="flex items-center justify-between pt-2"><strong class="text-sm">Body:</strong>
                            ${createCopyButton(content.body)}
                        </div>
                        <p class="p-2 bg-gray-50 text-sm rounded whitespace-pre-wrap">${content.body.replace(/\\n/g, '\n')}</p>

                        ${insights.length > 0 ? `
                            <strong class="text-sm pt-2 block">Key Insights:</strong>
                            <ul class="list-disc list-inside pl-2 space-y-1">
                                ${insights.map(insight => `<li class="text-sm text-gray-700">${insight}</li>`).join('')}
                            </ul>
                        ` : ''}

                        <div class="flex items-center justify-between pt-2"><strong class="text-sm">CTA:</strong> ${createCopyButton(content.cta)}</div>
                        <p class="p-2 bg-green-50 text-sm rounded">${content.cta}</p>

                        <!-- SEKCJA: Przyciski akcji -->
                        <div class="pt-4 border-t mt-4 space-y-2">
                            ${state.generatedHTML[langCode] ? `
                            <button
                                class="w-full px-4 py-2 bg-[#DC0028] text-white rounded-lg font-semibold hover:bg-[#DC0028]/90 flex items-center justify-center gap-2 text-sm"
                                data-action="preview-html"
                                data-lang="${langCode}"
                            >
                                <i data-lucide="monitor" class="w-4 h-4"></i> üìß Preview HTML Email
                            </button>
                            ` : ''}
                            <button
                                class="w-full px-4 py-2 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700 flex items-center justify-center gap-2 text-sm"
                                data-action="share-feedback"
                                data-lang="${langCode}"
                            >
                                <i data-lucide="message-circle" class="w-4 h-4"></i> üí¨ Share Feedback
                            </button>
                            <button
                                class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 flex items-center justify-center gap-2 text-sm disabled:bg-blue-300 disabled:cursor-wait"
                                data-action="generate-assets"
                                data-lang="${langCode}"
                                ${state.assetGenerationLoading === langCode ? 'disabled' : ''}
                            >
                                ${state.assetGenerationLoading === langCode
                                    ? '<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Generating...'
                                    : '<i data-lucide="sparkles" class="w-4 h-4"></i> ‚ú® Generate Campaign Assets'
                                }
                            </button>
                        </div>
                    </div>
                `;
            } else if (status.status !== 'processing') {
                // Poka≈º pole do rƒôcznego wklejania
                const prompt = getBasePrompt(LANGUAGES[langCode].name);
                contentContainer.innerHTML = `
                    <div class="flex items-center gap-2 text-sm text-gray-500"><i data-lucide="copy" class="w-3 h-3"></i><span>Copy the prompt to use in another AI, or...</span></div>
                    <div class="flex gap-2">
                        <input readonly value="${prompt.replace(/"/g, '&quot;')}" class="w-full px-3 py-2 bg-gray-100 rounded-lg text-sm font-mono truncate" />
                        ${createCopyButton(prompt)}
                    </div>
                    <textarea
                        placeholder="...paste a valid JSON reply for ${LANGUAGES[langCode].name} here."
                        class="w-full h-24 p-2 border rounded-lg text-sm font-mono focus:ring-2 outline-none resize-y ${status.status === 'error' ? 'border-red-400 focus:ring-red-400' : 'border-gray-300 focus:ring-[#DC0028]'}"
                        data-lang="${langCode}"
                    ></textarea>
                `;
                // Listener dla rƒôcznego wklejania
                const textarea = contentContainer.querySelector('textarea');
                if (textarea) {
                    textarea.addEventListener('change', (e) => handleManualPaste(langCode, e.target.value));
                }
            }

            // Zawsze na ko≈Ñcu renderowania karty, wywo≈Çaj createIcons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        function switchOutputFormat(format) {
            state.outputFormat = format;
            renderResults(); // Re-render to show/hide Export HTML button
        }

        function exportHTML() {
            if (!state.generatedHTML || Object.keys(state.generatedHTML).length === 0) return;

            // Create a ZIP-like download or individual files
            Object.entries(state.generatedHTML).forEach(([langCode, htmlContent]) => {
                const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
                const filename = `atradius-email-${langCode.toLowerCase()}.html`;
                downloadBlob(blob, filename);
            });
        }

        function renderResults() {
            if (!state.languageStatus) {
                dom.resultsContainer.innerHTML = '';
                return;
            }

            // Tworzenie nag≈Ç√≥wka z przyciskami eksportu
            const hasSuccess = Object.values(state.languageStatus).some(s => s.status === 'success');
            const isProcessingAny = Object.values(state.languageStatus).some(s => s.status === 'processing');
            const hasHTML = state.outputFormat === 'html' && Object.keys(state.generatedHTML).length > 0;
            const headerHTML = `
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 space-y-6">
                    <div class="flex flex-wrap justify-between items-center gap-4">
                        <h2 class="text-xl font-bold flex items-center gap-3"><span class="bg-[#DC0028] text-white rounded-full h-8 w-8 flex items-center justify-center font-bold">3</span> Review & Export</h2>
                        <div class="flex flex-wrap gap-2">
                            <!-- Format Selector -->
                            <div class="flex items-center gap-1 bg-gray-100 rounded-lg p-1">
                                <button id="formatJSON" class="px-3 py-1.5 text-xs font-semibold rounded ${state.outputFormat === 'json' ? 'bg-white shadow' : 'text-gray-600'}" data-format="json">JSON</button>
                                <button id="formatHTML" class="px-3 py-1.5 text-xs font-semibold rounded ${state.outputFormat === 'html' ? 'bg-white shadow' : 'text-gray-600'}" data-format="html">HTML</button>
                                <button id="formatCSV" class="px-3 py-1.5 text-xs font-semibold rounded ${state.outputFormat === 'csv' ? 'bg-white shadow' : 'text-gray-600'}" data-format="csv">CSV</button>
                            </div>
                            <!-- Export Buttons -->
                            <button id="emailResultsButton" ${!hasSuccess ? 'disabled' : ''} class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2 text-sm disabled:bg-gray-300">
                                <i data-lucide="mail" class="w-4 h-4"></i> Send by E-mail
                            </button>
                            ${hasHTML ? `
                            <button id="exportHTML" class="px-4 py-2 bg-[#DC0028] text-white rounded-lg hover:bg-[#DC0028]/90 flex items-center gap-2 text-sm">
                                <i data-lucide="code" class="w-4 h-4"></i> Export HTML
                            </button>
                            ` : ''}
                            <button id="exportJson" ${!hasSuccess ? 'disabled' : ''} class="px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-800 flex items-center gap-2 text-sm disabled:bg-gray-300">
                                <i data-lucide="download" class="w-4 h-4"></i> Export JSON
                            </button>
                            <button id="exportCsv" ${!hasSuccess ? 'disabled' : ''} class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center gap-2 text-sm disabled:bg-gray-300">
                                <i data-lucide="download" class="w-4 h-4"></i> Export CSV
                            </button>
                        </div>
                    </div>
                    <div class="space-y-4">
                        ${state.selectedLanguages.map(langCode => `
                            <div class="border border-gray-200 rounded-lg" id="card-${langCode}">
                                <div class="p-4 bg-gray-50 flex items-center justify-between">
                                    <h3 class="font-bold text-lg flex items-center gap-3">
                                        <span class="text-2xl">${LANGUAGES[langCode].flag}</span>
                                        ${LANGUAGES[langCode].name} (${langCode})
                                    </h3>
                                    <div class="status-container w-5 h-5">
                                        <!-- Status icon will be inserted here -->
                                    </div>
                                </div>
                                <div class="p-4 space-y-4 content-container">
                                    <!-- Content will be inserted here -->
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            dom.resultsContainer.innerHTML = headerHTML;

            // Podpiƒôcie listener√≥w eksportu
            document.getElementById('exportJson').addEventListener('click', () => exportData('json'));
            document.getElementById('exportCsv').addEventListener('click', () => exportData('csv'));
            // ‚ú® NOWY LISTENER: Przycisk e-maila
            document.getElementById('emailResultsButton').addEventListener('click', showEmailModal);
            // Format selectors
            document.getElementById('formatJSON').addEventListener('click', () => switchOutputFormat('json'));
            document.getElementById('formatHTML').addEventListener('click', () => switchOutputFormat('html'));
            document.getElementById('formatCSV').addEventListener('click', () => switchOutputFormat('csv'));
            // Export HTML button (if exists)
            const exportHTMLBtn = document.getElementById('exportHTML');
            if (exportHTMLBtn) {
                exportHTMLBtn.addEventListener('click', exportHTML);
            }

            // Wype≈Çnienie tre≈õci kart
            state.selectedLanguages.forEach(langCode => {
                renderCardContent(langCode);
            });

            // Aktywacja ikon
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        // --- INICJALIZACJA APLIKACJI ---

        document.addEventListener('DOMContentLoaded', () => {
            // Upewnij siƒô, ≈ºe lucide jest dostƒôpne, zanim spr√≥bujesz go u≈ºyƒá
            if (typeof lucide === 'undefined') {
                console.error('Lucide icons script failed to load.');
                return;
            }

            // Inicjalizacja zak≈Çadek
            dom.tabButtons.forEach(btn => {
                btn.addEventListener('click', handleTabClick);
            });

            // Listenery dla input√≥w
            dom.sourceUrlInput.addEventListener('input', (e) => {
                state.sourceUrl = e.target.value;
                checkReadiness();
            });
            dom.sourceTextInput.addEventListener('input', (e) => {
                state.sourceText = e.target.value;
                checkReadiness();
            });
            dom.sourceFileInput.addEventListener('change', handleFileChange);

            // Listenery dla Brand Audience
            dom.brandAudienceSelect.addEventListener('change', (e) => {
                state.brandAudience = e.target.value;
                // Show/hide custom textarea
                if (e.target.value === 'other') {
                    dom.brandAudienceCustom.classList.remove('hidden');
                } else {
                    dom.brandAudienceCustom.classList.add('hidden');
                    state.brandAudienceCustom = '';
                }
            });
            dom.brandAudienceCustom.addEventListener('input', (e) => {
                state.brandAudienceCustom = e.target.value;
            });

            // Inicjalizacja jƒôzyk√≥w
            renderLanguageSelector();

            // G≈Ç√≥wne przyciski
            dom.generateButton.addEventListener('click', handleGenerate);
            dom.cancelButton.addEventListener('click', handleCancel);

            // Listenery modala zasob√≥w
            dom.assetsModalCloseButton.addEventListener('click', hideModal);
            dom.assetsModal.addEventListener('click', (e) => {
                if (e.target === dom.assetsModal) hideModal();
            });

            // ‚ú® NOWE LISTENERY: Listenery modala e-mail
            dom.emailModalCloseButton.addEventListener('click', hideEmailModal);
            dom.emailModalCopyButton.addEventListener('click', copyEmailContent);
            dom.emailModal.addEventListener('click', (e) => {
                if (e.target === dom.emailModal) hideEmailModal();
            });

            // Listenery modala HTML Preview
            document.getElementById('htmlPreviewModalCloseButton').addEventListener('click', hideHTMLPreview);
            document.getElementById('htmlPreviewCopyButton').addEventListener('click', copyHTMLCode);
            document.getElementById('htmlPreviewDownloadButton').addEventListener('click', downloadHTMLFromPreview);
            document.getElementById('htmlPreviewModal').addEventListener('click', (e) => {
                if (e.target.id === 'htmlPreviewModal') hideHTMLPreview();
            });

            // Listenery modala API key
            document.getElementById('apiKeyButton').addEventListener('click', showApiKeyModal);
            document.getElementById('apiKeyModalCloseButton').addEventListener('click', hideApiKeyModal);
            document.getElementById('apiKeySaveButton').addEventListener('click', saveApiKey);
            document.getElementById('apiKeyClearButton').addEventListener('click', clearApiKey);
            document.getElementById('apiKeyModal').addEventListener('click', (e) => {
                if (e.target.id === 'apiKeyModal') hideApiKeyModal();
            });

            // Listenery modala Feedback
            document.getElementById('feedbackModalCloseButton').addEventListener('click', hideFeedbackModal);
            document.getElementById('feedbackCancelButton').addEventListener('click', hideFeedbackModal);
            document.getElementById('feedbackSubmitButton').addEventListener('click', submitFeedback);
            document.getElementById('feedbackModal').addEventListener('click', (e) => {
                if (e.target.id === 'feedbackModal') hideFeedbackModal();
            });
            // NPS rating slider
            document.getElementById('npsRating').addEventListener('input', (e) => {
                document.getElementById('npsRatingValue').textContent = e.target.value;
            });

            // Delegacja zdarze≈Ñ dla dynamicznych wynik√≥w
            dom.resultsContainer.addEventListener('click', handleResultsClick);

            // Stan poczƒÖtkowy
            checkReadiness();
            updateButtons();
            updateApiKeyStatus(); // Aktualizuj status API key

            // Inicjalizacja ikon
            lucide.createIcons();
        });

    </script>
</body>
</html>
